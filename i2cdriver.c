#include "i2cdriver.h"

// =================================================================================================
//  I2C INITIALIZATION
// =================================================================================================
void I2C_Init(void) {
    TWBR  =   0x20; // Setting the bit rate to 100KHz
    TWSR &=   ~((1<<TWPS1) | (1<<TWPS0)); // Prescaler=1
}

// =================================================================================================
//  I2C START
// =================================================================================================
uint8_t I2C_Start(void){
    TWCR  = ((1<<TWINT) | (1<<TWSTA) | (1<<TWEN));
    
    uint16_t timeout = 10000;
    while (!(TWCR & (1<<TWINT)) && timeout > 0) timeout--;
    
    if(timeout == 0) return 0xFF;
    return (TWSR & 0XF8); 
}

// =================================================================================================
//  I2C WRITE
// =================================================================================================
uint8_t I2C_Write(uint8_t data) {
    TWDR = data; 
    TWCR  = ((1<<TWINT) | (1<<TWEN)); 

    uint16_t timeout = 10000;
    while (!(TWCR & (1<<TWINT)) && timeout > 0) timeout--;

    if(timeout == 0) return 0xFF;
    return (TWSR & 0XF8);
}

// =================================================================================================
//  I2C READ WITH ACK
// =================================================================================================
uint8_t I2C_ReadWithACK(uint8_t *dataPtr) {
    TWCR  = ((1<<TWINT) | (1<<TWEA) | (1<<TWEN));

    uint16_t timeout = 10000;
    while (!(TWCR & (1<<TWINT)) && timeout > 0) timeout--;

    if(timeout == 0) return 0xFF;
    
    *dataPtr = TWDR; 
    return (TWSR & 0XF8);
}

// =================================================================================================
//  I2C READ WITH NACK
// =================================================================================================
uint8_t I2C_ReadWithNACK(uint8_t *dataPtr) {
    TWCR  = ((1<<TWINT) | (1<<TWEN)); 

    uint16_t timeout = 10000;
    while (!(TWCR & (1<<TWINT)) && timeout > 0) timeout--;

    if(timeout == 0) return 0xFF;
    
    *dataPtr = TWDR; 
    return (TWSR & 0XF8);
}

// =================================================================================================
//  I2C REPEATED START
// =================================================================================================
uint8_t I2C_RepeatedStart(void) {
    TWCR  = ((1<<TWINT) | (1<<TWSTA) | (1<<TWEN));
    
    uint16_t timeout = 10000;
    while (!(TWCR & (1<<TWINT)) && timeout > 0) timeout--;

    if(timeout == 0) return 0xFF;
    return (TWSR & 0XF8);
}

// =================================================================================================
//  I2C STOP
// =================================================================================================
void I2C_Stop(void) {

    TWCR  = ((1<<TWINT) | (1<<TWSTO) | (1<<TWEN)); 
}

void I2C_End(void) {
    TWCR &= ~(1<<TWEN); 
}
